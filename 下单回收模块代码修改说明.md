# 个人下单回收模块代码修改说明 (更新版)

> 最近更新日期：2025-10-11
>
> 本文在原始“个人下单回收模块”完成后，补充记录后续新增的高校下单、地址管理、价格计算、实体字段扩展、企业下单相关接口与测试方式等所有改动，便于团队成员同步最新设计与代码演进脉络。

---
## 目录
1. 初版回顾（个人下单功能）
2. 后续新增与调整总览
3. 新增/修改的核心模块与文件清单
4. 实体与数据库结构最新说明（含用户企业字段）
5. 订单创建/金额/地址/鉴权流程最新说明
6. 已修复问题与设计权衡
7. 测试脚本与调试方式（Swagger 与 HTTP 文件）
8. 待改进 / 下一步规划
9. 版本里程碑与时间线
10. 附：关键 API 列表（更新）

---
## 1. 初版回顾（个人下单功能）
初版交付内容（已在之前文档中说明）：
- 支持个人用户：创建订单 / 查询订单列表 / 取消订单
- 依赖：MyBatis-Plus、JWT 登录态、微信模拟登录（WeChatUtil 测试code）
- 核心类：`PersonOrderService(Impl)`、`OrderController`、`Order`、`OrderMapper`、`Result`、`JwtInterceptor` / `WebMvcConfig`

> 注意：初版文档中提及的 `OrderService / OrderServiceImpl` 命名与当前代码不完全一致，实际已采用更明确的 `PersonOrderService / PersonOrderServiceImpl`。

---
## 2. 后续新增与调整总览
| 类别 | 说明 | 状态 |
|------|------|------|
| 高校下单模块 | 新增教材回收 / 宿舍批量回收 | 已完成 |
| 地址管理模块 | 新增地址实体、创建/列表/设置默认接口 | 已完成 |
| 价格计算模块 | PriceConfig + PriceCalculationService(Impl) | 已完成（高校使用，个人暂为 0） |
| 订单实体扩展 | campus_type / campus_info / estimated_amount 默认逻辑 / items 默认值 | 已完成 |
| DTO 扩展 | TextbookOrderDTO / DormitoryOrderDTO + items 可选字段 | 已完成 |
| WeChat 测试能力 | test_mode + 动态 test_code 支持 | 已完成 |
| 时间戳自动填充 | MyMetaObjectHandler | 已完成 |
| 全局参数校验 | 加入 jakarta validation + @Valid | 已完成 |
| BUG 修复 | Field 'items' doesn't have a default value | 已修复（多层兜底） |
| HTTP 测试脚本 | 全链路包含：登录→建地址→个人下单→高校教材→高校宿舍 | 已更新 |
| 统一返回 | 高校/企业下单返回 estimatedAmount（企业可置空，后续运营填写） | 已完成 |
| 企业下单模块 | 企业批量下单 / 定期回收计划 | 已完成（接口） |

---
## 3. 新增/修改的核心模块与文件清单

### 3.1 新增文件（节选）
| 文件 | 作用 |
|------|------|
| `CampusOrderService` / `CampusOrderServiceImpl` | 高校订单创建（教材 / 宿舍）与高校身份校验 |
| `TextbookOrderDTO` / `DormitoryOrderDTO` | 高校订单专用请求数据载体（含 items 可选） |
| `UserAddress` | 用户地址实体，对应 `user_address` 表 |
| `UserAddressMapper` / `UserAddressService(Impl)` | 地址数据访问与归属校验 |
| `AddressController` | 地址创建 / 列表 / 设置默认接口 |
| `PriceConfig` | 基础价格 + 试点期价格配置（内置初值，可扩展 YAML 配置） |
| `PriceCalculationService` / `PriceCalculationServiceImpl` | 高校订单金额估算逻辑（教材 / 宿舍） |
| `MyMetaObjectHandler` | MyBatis-Plus 自动填充 createdAt / updatedAt |
| `SnowflakeIdGenerator` | 高校订单号（CAMP 前缀）生成 |
| `OrderTest.http`（更新） | 集成测试脚本，覆盖全流程 |
| `AddressCreateDTO` | 创建地址请求体 |
| `EnterpriseOrderController` | 企业订单接口（批量下单、回收计划） |
| `BulkOrderRequest` / `RecyclingPlanRequest` | 企业批量下单 / 定期回收计划请求模型 |
| `OrderItem` / `InvoiceInfo` | 企业订单项与发票信息模型 |
| `OrderResponse` / `RecyclingPlanResponse` / `ApiResponse` | 企业接口统一响应模型 |

### 3.2 重要修改文件（节选）
| 文件 | 修改要点 |
|------|-----------|
| `Order.java` | 新增 `campusType`、`campusInfo`、为 `items` 增加默认值`"[]"`，保留金额字段；增加中文注释 |
| `CampusOrderController` | 新增高校教材/宿舍下单 API，启用 @Valid |
| `OrderController` | 个人下单、订单列表、取消订单接口，增加 @Operation 注解（Swagger） |
| `PersonOrderServiceImpl` | 地址合法性校验；个人预估金额固定 0；日志增强 |
| `EnterpriseOrderController` | 新增企业批量下单与定期回收计划接口（Swagger 注解完整） |
| `EnterprisePriceService`（如启用） | 企业订单估价逻辑，支持吨/公斤转换与批量折扣 |
| `application.yml` | 统一 UTF-8、修正 mybatis-plus 包路径、加入价格配置、数据库 URL 规范化；context-path 为 `/api` |
| `pom.xml` | 添加 validation 依赖、编码属性、编译插件编码设置 |
| `GlobalExceptionHandler`（若存在） | 处理参数校验异常（收集 message） |
| `Result.java` | 支持链式 put；统一响应格式（个人模块使用） |

---
## 4. 实体与数据库结构最新说明（含用户企业字段）
### 4.1 `order` 表（新增 / 关注字段）
| 字段 | 说明 | 备注 |
|------|------|------|
| order_no | 订单号 | 个人：`ORD+UUID16`；高校：`CAMP+雪花ID`；企业：`ENT+规则`（视实现） |
| order_type | 1=个人 2=高校 3=企业 | 用于业务分流 |
| campus_type | 1=教材 2=宿舍 | 高校子类型 |
| campus_info | 高校扩展 JSON | 存教材/宿舍特征字段 |
| items | JSON（默认 "[]"） | 个人/高校/企业：物品明细 |
| estimated_amount | 预估金额 | 高校：由价格模块赋值；个人：0；企业：可置空，后续运营填写 |
| final_amount | 最终金额 | 后续结算使用 |

### 4.2 `user_address` 表
现有结构：`id,user_id,address_label,detail_address,contact_name,contact_phone,location,is_default,created_at,updated_at`
> 无 province/city/district 字段，实体已对齐；location 以 JSON 字符串存储（可后续加 TypeHandler）。

### 4.3 `user` 表新增企业相关字段
执行的 DDL（摘要）：
- `user_type` ENUM('personal','campus','enterprise') NOT NULL DEFAULT 'personal' 注：企业接口需要 `enterprise`；
- `company_name` VARCHAR(100)
- `unified_social_credit_code` VARCHAR(20)
- `invoice_title` VARCHAR(100)
- `tax_number` VARCHAR(20)

影响评估：
- 向后兼容：新增字段允许 NULL（除 user_type 有默认值），不会影响现有个人/高校流程；
- 企业接口会校验 `user_type=enterprise`，不具备资质则无法下企业单；
- 开票相关字段用于回填/默认值，具体以请求体 `invoiceInfo`/`invoiceConfig` 为准。

---
## 5. 最新业务流程说明（含个人与企业）
### 5.1 个人下单流程与接口
- 控制器：`OrderController`
- 路径前缀：`/api`（来自 `server.servlet.context-path`）
- 认证：`Authorization: Bearer {token}`

1) 创建个人回收订单
- 方法与路径：`POST /api/order/personal`
- 请求头：`Authorization: Bearer {token}`
- 请求体：JSON（当前使用 `Map<String,Object>` 承载）
  - 常见字段：
    - `addressId` Long 必填（需归属校验）
    - `items` 数组 可选（不传也可，后端有兜底）
    - `appointmentTime` String 可选（格式 `yyyy-MM-dd HH:mm:ss`）
    - 其他字段按页面表单填充
- 返回：`Result{ code, message, data }`
  - 成功时 `code=200`，`data` 通常包含 `orderId`、`orderNo` 等
- 规则：
  - 预估金额固定 0（个人不计价）
  - 地址必须是当前用户的默认或指定地址；否则返回错误信息

2) 获取用户订单列表
- 方法与路径：`GET /api/order/list?page=1&size=10`
- 返回：`Result{ code, message, data }`，按创建时间倒序

3) 取消订单
- 方法与路径：`POST /api/order/cancel/{orderId}`
- 规则：仅允许取消状态为“待接单”的订单

示例请求（创建个人订单）：
```
POST /api/order/personal
Authorization: Bearer {token}
Content-Type: application/json

{
  "addressId": 123,
  "items": [{"category":"waste_paper","quantity":2,"weightKg":5}],
  "appointmentTime": "2025-10-12 10:00:00"
}
```
成功标志：HTTP 200 且响应 `code=200`。

### 5.2 高校订单（教材/宿舍）
- 控制器：`CampusOrderController`
- 路径前缀：`/api/campusOrder`
- Swagger 分组：`校园订单下单`
- 认证：`Authorization: Bearer {token}`

1) 创建教材回收订单
- 方法与路径：`POST /api/campusOrder/textbook`
- 请求体模型：`TextbookOrderDTO`
  - `addressId` Long 必填
  - `scheduledTime` Date 必填（`@Future`，建议格式 `yyyy-MM-dd HH:mm:ss`）
  - `images` List<String> 可选
  - `textbookType` String 必填
  - `quantity` Integer 必填（>=1）
  - `unit` String 可选
  - `condition` String 必填
  - `pickupLocation` String 必填
  - `schoolName` String 可选
  - `department` String 可选
  - `items` List<Map<String,Object>> 可选（直接写入订单 items 字段）
- 响应：`Result{ code, message, data }`
- 规则：
  - 地址归属校验（须为当前用户地址）
  - 金额估算：已接入高校价格模块（如配置开启）

示例请求：
```
POST /api/campusOrder/textbook
Authorization: Bearer {token}
Content-Type: application/json

{
  "addressId": 123,
  "scheduledTime": "2025-10-12 09:30:00",
  "images": ["http://example.com/a.jpg"],
  "textbookType": "通识教材",
  "quantity": 20,
  "unit": "本",
  "condition": "八成新",
  "pickupLocation": "一号教学楼北门",
  "schoolName": "某某大学",
  "department": "计算机学院",
  "items": [{"category":"waste_paper","weightKg":10}]
}
```
成功标志：HTTP 200 且响应 `code=200`，`data` 中包含订单标识。

2) 创建宿舍回收订单
- 方法与路径：`POST /api/campusOrder/dormitory`
- 请求体模型：`DormitoryOrderDTO`
  - `addressId` Long 必填
  - `scheduledTime` Date 必填（`@Future`，建议格式 `yyyy-MM-dd HH:mm:ss`）
  - `images` List<String> 可选
  - `dormitoryBuilding` String 必填
  - `roomRange` String 必填（如："1-5层，501-520"）
  - `recyclingCategories` List<String> 必填（至少一项）
  - `contactPerson` String 必填
  - `contactPhone` String 必填（大陆手机号正则校验）
  - `schoolName` String 可选
  - `department` String 可选
  - `items` List<Map<String,Object>> 可选（统一写入订单 items 字段）
- 响应：`Result{ code, message, data }`
- 规则：
  - 地址归属校验
  - 可结合价格模块估算金额（按配置）

示例请求：
```
POST /api/campusOrder/dormitory
Authorization: Bearer {token}
Content-Type: application/json

{
  "addressId": 123,
  "scheduledTime": "2025-10-12 14:00:00",
  "images": [],
  "dormitoryBuilding": "东区3号楼",
  "roomRange": "301-320",
  "recyclingCategories": ["waste_paper","plastic_bottle"],
  "contactPerson": "张三",
  "contactPhone": "13800000000",
  "schoolName": "某某大学",
  "department": "材料学院",
  "items": [{"category":"plastic_bottle","weightKg":30}]
}
```
成功标志：HTTP 200 且响应 `code=200`，`data` 中包含订单标识。

### 5.3 企业批量回收下单
- 控制器：`EnterpriseOrderController`
- 方法与路径：`POST /api/enterprise/orders/bulk`
- 认证：`Authorization: Bearer {token}`（需要企业资质）
- 请求体模型：`BulkOrderRequest`
  - `items` List<OrderItem> 必填
  - `totalWeight` BigDecimal 必填，且 > 0（`@DecimalMin("0.1")`）
  - `weightUnit` WeightUnit 可选，默认 `KG`（支持 `KG`、`TON` 等）
  - `invoiceRequired` Boolean 可选，默认 `false`
  - `pickupAddress` String 必填
  - `contactPerson` String 必填
  - `contactPhone` String 必填，中国大陆手机号正则校验
  - `scheduleTime` LocalDateTime 可选，若传必须晚于当前时间
  - `invoiceInfo` InvoiceInfo 可选，含 `invoiceTitle`、`taxNumber`
- 响应：`ApiResponse<OrderResponse>`
  - 关键字段：`id`、`orderNo`、`orderType`、`estimatedAmount`（当前实现可为空，后续由运营填入）、`status`
- 说明：
  - 资质校验：`enterpriseService.validateEnterpriseQualification(token)` 校验 `user_type=enterprise` 等条件
  - 价格：默认不强制计算。如需启用系统估价，切换为 `EnterprisePriceService.calculateEnterpriseAmount(...)`

示例请求：
```
POST /api/enterprise/orders/bulk
Authorization: Bearer {token}
Content-Type: application/json

{
  "items": [
    {"category": "waste_paper", "quantity": 10, "weightKg": 100},
    {"category": "plastic_bottle", "quantity": 5, "weightKg": 50}
  ],
  "totalWeight": 150,
  "weightUnit": "KG",
  "invoiceRequired": true,
  "pickupAddress": "上海市浦东新区世纪大道100号",
  "contactPerson": "李四",
  "contactPhone": "13812345678",
  "scheduleTime": "2025-10-12T11:00:00",
  "invoiceInfo": {"invoiceTitle": "某某环保科技有限公司", "taxNumber": "91310000MA1K123456"}
}
```
成功标志：HTTP 200 且响应 `code=200`，`data.orderNo` 非空。

### 5.4 企业定期回收计划
- 控制器：`EnterpriseOrderController`
- 方法与路径：`POST /api/enterprise/plans`
- 认证：`Authorization: Bearer {token}`（需要企业资质）
- 请求体模型：`RecyclingPlanRequest`
  - `planName` String 必填
  - `cycleType` String 必填（`WEEKLY/BIWEEKLY/MONTHLY`）
  - `totalCycles` Integer 可选（>0），为空代表不限次数
  - `nextScheduleDate` LocalDate 必填（`@FutureOrPresent`）
  - `endDate` LocalDate 可选
  - `itemsConfig` String 必填（JSON 字符串）
  - `invoiceConfig` String 可选（JSON 字符串）
  - `startImmediately` Boolean 可选，若 true 将生成首单，并自动计算下一次执行日期
- 响应：`ApiResponse<RecyclingPlanResponse>`，包含 `id`、`planNo`、`planName`、`cycleType`、`status`

示例请求：
```
POST /api/enterprise/plans
Authorization: Bearer {token}
Content-Type: application/json

{
  "planName": "每周回收计划",
  "cycleType": "WEEKLY",
  "totalCycles": 12,
  "nextScheduleDate": "2025-10-13",
  "endDate": null,
  "itemsConfig": "{\"waste_paper\":\"100kg\",\"plastic_bottle\":\"50kg\"}",
  "invoiceConfig": "{\"invoiceTitle\":\"某某环保科技有限公司\",\"taxNumber\":\"91310000MA1K123456\"}",
  "startImmediately": true
}
```
成功标志：HTTP 200 且响应 `code=200`，`data.planNo` 非空。

---
## 6. 已修复问题与设计权衡
| 问题 | 现象 | 处理方案 | 备注 |
|------|------|---------|------|
| application.yml 编码异常 | 启动 YAML 解析失败 | 统一 UTF-8 + VM `-Dfile.encoding=UTF-8` | 已稳定 |
| Field 'items' doesn't have a default value | 高校/企业订单插入失败 | 三层兜底：服务层 setItems / 实体默认值 / 前端可传 | 已解决 |
| 地址外键约束失败 | 地址不存在或归属不符 | 下单前校验 + 明确错误提示 | 支持多用户并发 |
| 高校/企业订单金额控制 | 估价策略多变 | 引入配置与服务分层，可切换“系统估价/运营后填” | 便于灰度 |
| Swagger 访问路径 | context-path 影响 | Swagger UI：`/api/swagger-ui/index.html` | 详见下节 |

---
## 7. 测试脚本与调试方式（Swagger 与 HTTP 文件）
- Swagger 测试步骤：
  1) 启动服务后访问：`http://localhost:8080/api/swagger-ui/index.html`
  2) 右上角“Authorize”填入 `Bearer {token}`（含空格）；token 可通过 `/auth/wechat/login` 获取测试登录态
  3) 在“订单管理接口”中测试个人接口：`POST /order/personal`、`GET /order/list`、`POST /order/cancel/{orderId}`
  4) 在“校园订单下单”中测试高校接口：`POST /campusOrder/textbook`、`POST /campusOrder/dormitory`
  5) 在“企业订单接口”中测试企业接口：`POST /enterprise/orders/bulk`、`POST /enterprise/plans`
  6) 成功标准：HTTP 200 且响应体 `code=200`，`data` 中关键标识（如 `orderNo`/`planNo`）非空

- HTTP 文件（IDEA）动态变量：
  - `OrderTest.http` 中出现的 `{{token}}`、`{{nextHour}}`、`{{nextDay}}` 需在 `http-client.private.env.json` 中配置。
  - 示例：
    ```json
    {
      "dev": {
        "token": "替换为实际Bearer后半段或完整串",
        "nextHour": "2025-10-12T11:00:00",
        "nextDay": "2025-10-13"
      }
    }
    ```
  - 运行前选择对应环境（如 dev），避免“未替换的变量”报错。

- 企业测试账号：
  - 企业接口会校验资质。建议新建或转换一个用户 `user_type=enterprise`，并可按需补充 `company_name`、`unified_social_credit_code`、`invoice_title`、`tax_number`。
  - 不想改动现有个人用户时，可新增一条用户记录或提供模拟登录 code 绑定到新企业用户。

---
## 8. 待改进 / 下一步规划
| 优先级 | 事项 | 说明 |
|--------|------|------|
| 高 | 统一订单状态/类型枚举 | 消除魔法数字，集中常量管理 |
| 高 | 订单详情接口 | 解析 campusInfo & items 返回结构化数据 |
| 中 | 企业订单定价链路 | 开关化系统估价与运营定价、记录策略版本 |
| 中 | 地址修改/删除接口 | 支持地址维护生命周期 |
| 中 | 日志 & 审计 | AOP 记录下单 / 取消 / 估价关键参数 |
| 低 | 统一异常码 | 规范化 code（如 400/401/403/500） |
| 低 | 国际化支持 | message 外置化 |
| 低 | 单元 / 集成测试完善 | 覆盖 PriceCalculation / CampusOrder / EnterpriseOrder |

---
## 9. 版本里程碑与时间线
| 日期 | 里程碑 | 说明 |
|------|--------|------|
| 初版（之前） | 个人下单模块 | 基础 CRUD + JWT 鉴权 |
| 2025-09-28 (上午) | 价格计算草案接入 | 高校订单初步计算逻辑接入 |
| 2025-09-28 (中午) | 高校教材/宿舍接口完成 | DTO + 校验 + 金额 + campusInfo |
| 2025-09-28 (下午) | 地址管理模块上线 | create / list / default + 校验链路打通 |
| 2025-09-28 (下午) | items NOT NULL BUG 修复 | 三层兜底策略完成 |
| 2025-10-11 (晚) | 企业批量/计划接口补充文档 | Swagger 测试说明与字段对齐 |

---
## 10. 附：关键 API 列表（更新）
| 接口 | 方法 | 说明 |
|------|------|------|
| /auth/wechat/login | POST | 获取 token（支持测试 code） |
| /address/create | POST | 创建地址 |
| /address/list | GET | 地址列表 |
| /order/personal | POST | 个人下单 |
| /order/list | GET | 个人订单列表 |
| /order/cancel/{id} | POST | 取消个人订单 |
| /campusOrder/textbook | POST | 高校教材订单创建 |
| /campusOrder/dormitory | POST | 高校宿舍订单创建 |
| /enterprise/orders/bulk | POST | 企业批量回收下单（需企业资质） |
| /enterprise/plans | POST | 创建企业定期回收计划（需企业资质） |

---
> 若本文件与代码存在偏差，请以最新代码为准，并及时回写文档保持一致性。
